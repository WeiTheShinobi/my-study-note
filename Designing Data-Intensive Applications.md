# 資料密集系統設計 Designing Data-Intensive Applications

> 筆記作者：WeiTheShinobi

## 第一章 可靠性、可擴展性、可維護性

現在大部分的應用程式都是資料密集而非計算密集，資料才是問題，還好人類已經研究很多很好的抽象解決這些問題。本章會先走一次基礎知識，接下來的章節層層推進。現在的應用系統由多個組件和資料系統組合而成。

### 可靠性

> 即時發生了故障，系統依舊能正常工作。

故障是不可能完全消除的，故意產生故障來檢驗系統是很好的，因為許多 bug 是由於不當的錯誤處理。硬體、軟體、人為都有可能出錯，軟體的故障出於對執行的系統有某些假設，而人為故障是最常發生的，例如環境配置錯誤，想要降低人為失誤：

- 設計系統時就減少出錯機會
- 完整的測試：整合、單元、手動測試
- 測試環境
- 好的監控系統：好的 log，記錄出錯
- 能輕鬆地回滾

並不是只有核電廠的系統需要可靠性，想想一個老奶奶把所有的照片都存在你的系統中，如果系統出錯他們的感受如何。

### 可擴展性

> 描述系統對於負載增加的能力

以 Twitter 為例，分為兩個功能，讀取和寫入文章，而這兩種功能分別有不同量級，一個被三千萬人追蹤的明星發布文章跟一般人的量級又不一樣。

我們通常關心吞吐量與回應時間，而回應時間也不該只是一個平均數字，而是要看他的分布狀況，通常會因為 IO 問題有一些異常值。人們常常以平均時間來當作指標，但這不太好。**首先將數值做排序，然後選擇百分位數**，例如 p50(中位數), p95 或 p99 都不錯，假如中位數延遲是200ms，代表有一半的人不超過，而高百分位通常代表高價值客戶，要確保這些人開心。根據 Amazon 的資料：回應每增加 100ms，銷售減少 1%；延遲 1 秒使客戶滿意度下降 16％。當然優化 p99 並不容易，因為這通常是因為發生不可控事件。

一個請求可能涉及多個後端服務，而最慢的服務會拖慢整體進度，每分鐘監控並作圖計算百分位數，降低取樣精度或是結合多台機器並沒有意義。

### 應對負載

可以大致區分為水平擴展和垂直擴展，無狀態的服務水平擴展容易，有狀態的資料系統水平擴展會增加系統複雜度。大規模的系統需要高度訂製，沒有銀彈，例如每秒十萬次請求和每秒三次但每次 2GB 的系統非常不同，快速迭代通常比為假想做準備好。

### 可維護性

軟體開發大部分的成本在於維護遺留系統，特別注意三個原則：

- 可維運性

有人說好的維運可以帶起壞的軟體，但壞的維運帶不動好的軟體。

- 簡單性

緊密耦合、依賴關係混亂、奇怪的特例，複雜讓維護變得超困難，容易出現 bug 而且超累人，消除複雜性最佳工具就是**抽象**，就像程式語言是機器碼、系統呼叫的抽象，SQL 是磁碟和記憶體資料結構的抽象，但道理人人都懂，做出好的抽象不容易。書中後面會提到。

- 可演化性

需求總是不斷變化，本書會探討大的資料系統中，提高敏捷性的做法，例如前面提到的 Twitter。

### 小節

一個系統要滿足多種需求，包括**功能性需求**（要做什麼事）與非功能性需求（可靠、可擴展），可靠性意味著系統故障依然可運作，可擴展性是指系統應對負載增加，可維護性要好的運維和好的抽象。

## 資料模型與查詢語言

