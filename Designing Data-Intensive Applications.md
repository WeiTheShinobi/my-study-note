# 資料密集系統設計 Designing Data-Intensive Applications

> 筆記作者：WeiTheShinobi

## 第一章 可靠性、可擴展性、可維護性

現在大部分的應用程式都是資料密集而非計算密集，資料才是問題，還好人類已經研究很多很好的抽象解決這些問題。本章會先走一次基礎知識，接下來的章節層層推進。現在的應用系統由多個組件和資料系統組合而成。

### 可靠性

> 即時發生了故障，系統依舊能正常工作。

故障是不可能完全消除的，故意產生故障來檢驗系統是很好的，因為許多 bug 是由於不當的錯誤處理。硬體、軟體、人為都有可能出錯，軟體的故障出於對執行的系統有某些假設，而人為故障是最常發生的，例如環境配置錯誤，想要降低人為失誤：

- 設計系統時就減少出錯機會
- 完整的測試：整合、單元、手動測試
- 測試環境
- 好的監控系統：好的 log，記錄出錯
- 能輕鬆地回滾

並不是只有核電廠的系統需要可靠性，想想一個老奶奶把所有的照片都存在你的系統中，如果系統出錯他們的感受如何。

### 可擴展性

> 描述系統對於負載增加的能力

以 Twitter 為例，分為兩個功能，讀取和寫入文章，而這兩種功能分別有不同量級，一個被三千萬人追蹤的明星發布文章跟一般人的量級又不一樣。

我們通常關心吞吐量與回應時間，而回應時間也不該只是一個平均數字，而是要看他的分布狀況，通常會因為 IO 問題有一些異常值。人們常常以平均時間來當作指標，但這不太好。**首先將數值做排序，然後選擇百分位數**，例如 p50(中位數), p95 或 p99 都不錯，假如中位數延遲是200ms，代表有一半的人不超過，而高百分位通常代表高價值客戶，要確保這些人開心。根據 Amazon 的資料：回應每增加 100ms，銷售減少 1%；延遲 1 秒使客戶滿意度下降 16％。當然優化 p99 並不容易，因為這通常是因為發生不可控事件。

一個請求可能涉及多個後端服務，而最慢的服務會拖慢整體進度，每分鐘監控並作圖計算百分位數，降低取樣精度或是結合多台機器並沒有意義。

### 應對負載

可以大致區分為水平擴展和垂直擴展，無狀態的服務水平擴展容易，有狀態的資料系統水平擴展會增加系統複雜度。大規模的系統需要高度訂製，沒有銀彈，例如每秒十萬次請求和每秒三次但每次 2GB 的系統非常不同，快速迭代通常比為假想做準備好。

### 可維護性

軟體開發大部分的成本在於維護遺留系統，特別注意三個原則：

- 可維運性

有人說好的維運可以帶起壞的軟體，但壞的維運帶不動好的軟體。

- 簡單性

緊密耦合、依賴關係混亂、奇怪的特例，複雜讓維護變得超困難，容易出現 bug 而且超累人，消除複雜性最佳工具就是**抽象**，就像程式語言是機器碼、系統呼叫的抽象，SQL 是磁碟和記憶體資料結構的抽象，但道理人人都懂，做出好的抽象不容易。書中後面會提到。

- 可演化性

需求總是不斷變化，本書會探討大的資料系統中，提高敏捷性的做法，例如前面提到的 Twitter。

### 小節

一個系統要滿足多種需求，包括**功能性需求**（要做什麼事）與非功能性需求（可靠、可擴展），可靠性意味著系統故障依然可運作，可擴展性是指系統應對負載增加，可維護性要好的運維和好的抽象。

## 第二章 資料模型與查詢語言

本章探討關聯式資料庫、文件資料庫和圖像資料庫

### 關聯模型與文件模型

模型百家爭鳴，關聯模型最終主導了持續三十年，而為了彈性與表達力，NoSQL出現了。SQL 在應用層與資料層中會有笨拙的轉換層。

關聯模型做的就是把資料攤開，靠查詢優化器搜尋，一個通用的優化器比手寫每個最佳做法好得多，關聯模型有簡潔的 join，多對一和多對多關係。

文件模型可以產生方便的一對多樹，但不太好多對一、多對多，如果想 join 就要處理應用程式碼，但是只要用在適合的場景就好了，像是紀錄 log，文件模型有較好的靈活性在遷移上（migration）。（schema-on-read）

現在很多 RMDBS 都支援 JSON 和 XML，兩者之前越來越近，一個列內不一定要是基本型別，可以是嵌套關係。

### 宣告式與命令式

宣告式抽象的告知要求，不知道查詢的細節，命令式告訴程式要怎麼找到資料，也有一種混合式的 MapReduce，基本上有函數式的味道。

### Graph-Like 資料模型

表如其名，就像是一個圖型一樣，由頂點和邊組合而成，關聯模型可以處理簡單的多對多，但是需求越來越複雜的話，使用圖像模型會更自然，圖像模型可以表現不同質的資料，一個人可以和喜歡什麼、文章、活動連結在一起。

每個**點**會有向外、向內和資料，每個**邊**會有開始、結束、標籤和屬性》

怎麼搜尋呢？假如要找從美國移民到歐洲的人，只要找出生標籤的邊連美國點、生活標籤的邊連歐洲點，然後回傳這些點的屬性即可。

### 小結

雖然這三種模型至今被廣泛使用，但特定領域還是需要特別實作：

- 基因：類似但不同的超長字串
- 粒子物理：超大量計算
- 全文檢索

## 第三章 資料儲存與檢索

